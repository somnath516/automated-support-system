<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Operator Dashboard</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="/socket.io/socket.io.js"></script>

<style>
:root {
  --bg: #f4f6f8;
  --card: #ffffff;
  --text: #2c3e50;
  --sidebar1: #2c3e50;
  --sidebar2: #34495e;
}

body.dark {
  --bg: #1e1e2f;
  --card: #2c2c3e;
  --text: #ffffff;
  --sidebar1: #111827;
  --sidebar2: #1f2937;
}

* { margin:0; padding:0; box-sizing:border-box; }

body {
  font-family: 'Poppins', sans-serif;
  background: var(--bg);
  color: var(--text);
  transition: 0.3s;
}

.layout { display:flex; }

/* Sidebar */
.sidebar {
  width:250px;
  min-height:100vh;
  background: linear-gradient(180deg,var(--sidebar1),var(--sidebar2));
  color:white;
  padding:25px;
}

.sidebar h2 { margin-bottom:30px; }

.menu-item {
  padding:12px;
  margin-bottom:10px;
  border-radius:8px;
  cursor:pointer;
  transition:0.3s;
}

.menu-item:hover { background:rgba(255,255,255,0.1); }

.logout {
  margin-top:30px;
  background:#e74c3c;
  text-align:center;
}

/* Main */
.main-content { flex:1; padding:30px; }

.topbar {
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:25px;
}

button.toggle {
  padding:8px 14px;
  border:none;
  border-radius:8px;
  cursor:pointer;
  background:#3498db;
  color:white;
}

/* Card */
.card {
  background:var(--card);
  padding:25px;
  border-radius:15px;
  text-align:center;
  box-shadow:0 6px 15px rgba(0,0,0,0.05);
  margin-bottom:25px;
  transition:0.3s;
}

.card:hover { transform:translateY(-5px); }

.card h3 { font-size:16px; opacity:0.7; }

.card p {
  font-size:30px;
  font-weight:700;
  margin-top:10px;
}

/* Table */
table {
  width:100%;
  border-collapse:collapse;
  background:var(--card);
  border-radius:12px;
  overflow:hidden;
}

th, td {
  padding:12px;
  border-bottom:1px solid #eee;
}

th { background:#ecf0f1; }

body.dark th { background:#3a3a4f; }

tr:hover { background:rgba(0,0,0,0.03); }

.badge {
  padding:4px 10px;
  border-radius:12px;
  color:white;
  font-size:12px;
}

.High { background:#e74c3c; }
.Medium { background:#f39c12; }
.Low { background:#2ecc71; }

button.action {
  padding:6px 10px;
  border:none;
  border-radius:6px;
  cursor:pointer;
  margin-right:5px;
  color:white;
}

.progress-btn { background:#f39c12; }
.close-btn { background:#2ecc71; }

.empty {
  text-align:center;
  padding:20px;
  font-weight:500;
}
</style>
</head>

<body>

<script>
if (localStorage.getItem("role") !== "operator") {
  alert("Access denied");
  window.location.href = "/login.html";
}
</script>

<div class="layout">

<div class="sidebar">
  <h2>Operator Panel</h2>
  <div class="menu-item">Dashboard</div>
  <div class="menu-item logout" onclick="logout()">Logout</div>
</div>

<div class="main-content">

<div class="topbar">
  <h1>My Assigned Tickets</h1>
  <button class="toggle" onclick="toggleDark()">Toggle Dark Mode</button>
</div>

<div class="card">
  <h3>Total Assigned Tickets</h3>
  <p id="ticketCount">0</p>
</div>

<table id="ticketTable">
<thead>
<tr>
<th>#</th>
<th>Title</th>
<th>Priority</th>
<th>Status</th>
<th>Action</th>
</tr>
</thead>
<tbody></tbody>
</table>

</div>
</div>

<script>
const socket = io();
const operatorName = localStorage.getItem("operatorName");

/* Dark Mode */
function toggleDark() {
  document.body.classList.toggle("dark");
}

function logout() {
  localStorage.clear();
  window.location.href = "/login.html";
}

/* Animated Counter */
function animateCounter(value) {
  let start = 0;
  const element = document.getElementById("ticketCount");
  const step = Math.ceil(value / 30);

  const interval = setInterval(() => {
    start += step;
    if (start >= value) {
      element.innerText = value;
      clearInterval(interval);
    } else {
      element.innerText = start;
    }
  }, 20);
}

function loadTickets() {

  fetch(`/api/operator/${operatorName}`)   // STRICT separation
  .then(res => res.json())
  .then(tickets => {

    const tbody = document.querySelector("#ticketTable tbody");
    tbody.innerHTML = "";

    if (!tickets || tickets.length === 0) {
      tbody.innerHTML = "<tr><td colspan='5' class='empty'>No tickets assigned</td></tr>";
      animateCounter(0);
      return;
    }

    tickets.forEach((ticket, i) => {
      const tr = document.createElement("tr");

      tr.innerHTML = `
        <td>${i + 1}</td>
        <td>${ticket.title}</td>
        <td><span class="badge ${ticket.priority}">${ticket.priority}</span></td>
        <td>${ticket.status}</td>
        <td>
          ${ticket.status !== "Closed" ? `
            <button class="action progress-btn" onclick="updateStatus(${ticket.id}, 'In Progress')">In Progress</button>
            <button class="action close-btn" onclick="updateStatus(${ticket.id}, 'Closed')">Close</button>
          ` : "Completed"}
        </td>
      `;
      tbody.appendChild(tr);
    });

    animateCounter(tickets.length);
  });
}

function updateStatus(ticketId, status) {
  fetch(`/api/tickets/${ticketId}/status`, {
    method: "PUT",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ status })
  }).then(() => loadTickets());
}

/* Real-time updates */
socket.on("newTicket", ticket => {
  if (ticket.assignedTo === operatorName) {
    loadTickets();
  }
});

socket.on("ticketStatusUpdated", ticket => {
  if (ticket.assignedTo === operatorName) {
    loadTickets();
  }
});

loadTickets();
</script>

</body>
</html>
